name: CI/CD

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  ci-cd:
    name: CI/CD
    uses: StudioLE/Actions/.github/workflows/ci-cd-rust.yml@v7
    with:
      package_name: photo_sort
      binary_name: photo_sort
      brew_repo: StudioLE/homebrew-tap
      brew_formula: |
        class PhotoSort < Formula
          desc "A tool to rename and sort photos/videos by its EXIF date/metadata"
          homepage "https://github.com/StudioLE/PhotoSort"
          license "GPL-3.0-or-later"
          version "{{version}}"

          on_linux do
            if Hardware::CPU.arm?
              url "https://github.com/StudioLE/PhotoSort/releases/download/v{{version}}/{{binary_name}}-{{version}}-aarch64-unknown-linux-gnu.tar.xz"
              sha256 "{{sha256:aarch64-unknown-linux-gnu}}"
            else
              url "https://github.com/StudioLE/PhotoSort/releases/download/v{{version}}/{{binary_name}}-{{version}}-x86_64-unknown-linux-gnu.tar.xz"
              sha256 "{{sha256:x86_64-unknown-linux-gnu}}"
            end
          end

          on_macos do
            if Hardware::CPU.arm?
              url "https://github.com/StudioLE/PhotoSort/releases/download/v{{version}}/{{binary_name}}-{{version}}-aarch64-apple-darwin.tar.xz"
              sha256 "{{sha256:aarch64-apple-darwin}}"
            else
              url "https://github.com/StudioLE/PhotoSort/releases/download/v{{version}}/{{binary_name}}-{{version}}-x86_64-apple-darwin.tar.xz"
              sha256 "{{sha256:x86_64-apple-darwin}}"
            end
          end

          def install
            bin.install "{{binary_name}}"
          end

          test do
            system "#{bin}/{{binary_name}}", "--help"
          end
        end
    secrets:
      cargo_registry_token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      brew_repo_token: ${{ secrets.BREW_REPO_TOKEN }}
